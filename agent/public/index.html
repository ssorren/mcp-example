<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kong Gateway Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Inter Font (Exact from Kong portal) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Highlight.js (dark theme to match Kong dark mode) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/nord.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      --kong-primary: rgb(66, 140, 220);      /* Kong blue (links, buttons) */
      --kong-bg: rgb(2, 20, 40);           /* Dark near-black bg (portal primary) */
      --kong-surface: rgb(4, 40, 79);      /* Dark gray surface (sidebar/chat) */
      --kong-text: #ffffff;         /* White primary text */
      --kong-text-muted: #d1d5db;   /* Light gray muted text */
      --kong-border: #374151;       /* Subtle dark border */
      --kong-accent: rgb(2, 20, 40);       /* Message bg (darker gray) */
      --kong-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Portal shadow */
      --sidebar-width: 280px;
    }

    * { box-sizing: border-box; margin: 0;}
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--kong-bg);
      color: var(--kong-text);
      display: flex;
      height: 100vh;
      overflow: hidden;
      font-size: 16px;
      line-height: 1.5;
    }
--color-brand: 66, 140, 220;
    /* Sidebar (Absolute fixed - no layout interference) */
    #sidebar {
      position: absolute;
      left: 0;
      top: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--kong-surface);
      border-right: 1px solid var(--kong-border);
      display: flex;
      flex-direction: column;
      z-index: 100;
      box-shadow: var(--kong-shadow);
      overflow-y: auto;
      padding-right: 0; /* No extra padding causing margins */
    }
    #sidebar-header {
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    #kong-logo {
      height: 28px;
      width: auto;
      filter: brightness(1.2); /* Slight lift for dark mode visibility */
    }
    #sidebar-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--kong-primary);
    }
    #mcp-section {
      padding: 1.5rem;
      flex: 1;
    }
    #mcp-section h3 {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--kong-text-muted);
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .mcp-checkbox {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 0;
      cursor: pointer;
      font-size: 1rem;
      color: var(--kong-text);
      border-radius: 0.25rem;
      transition: background 0.2s;
    }
    .mcp-checkbox:hover {
      background: var(--kong-accent);
      color: var(--kong-primary);
    }
    .mcp-checkbox input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      accent-color: var(--kong-primary);
      flex-shrink: 0;
      background: var(--kong-surface);
      border: 1px solid var(--kong-border);
    }

    /* Main Content (Full viewport minus sidebar - zero margin bleed) */
    #main {
      position: absolute;
      left: var(--sidebar-width);
      top: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--kong-surface); /* Dark surface like portal */
    }
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;                  /* Fixed, consistent padding */
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      justify-content: flex-start;    /* NEW: No centering, flush top alignment */
      /* Prevent any margin/overflow issues */
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      margin: 0;                      /* Explicit zero margin */
    }
    /* ---- 1. Put this in the <style> block (replace the old .msg / .bot rules) ---- */

.msg {
  max-width: 70%;                     /* tighter than 75% */
  padding: 2rem;              /* keep the original padding */
  border-radius: 0.5rem;
  line-height: 1.6;
  box-shadow: var(--kong-shadow);
  margin: 0;                          /* no extra margin */
  overflow-wrap: break-word;          /* force long words to wrap */
  word-break: break-word;             /* extra safety for tokens */
  hyphens: auto;                      /* nicer line breaks */
  position: relative;
  width: auto;
}
.user {
  align-self: flex-end;
  background: var(--kong-primary);
  color: var(--kong-text);
  margin-left: auto;
}
.bot {
  align-self: flex-start;
  background: var(--kong-accent);
  color: var(--kong-text);
  border: 1px solid var(--kong-border);
  margin-right: 2rem;                 /* keep the bubble away from the right edge */
}

    .typing {
      font-style: italic;
      color: var(--kong-text-muted);
    }

    /* Input Area (Pinned bottom - no overlap) */
    #input-area {
      display: flex;
      flex-direction: column;
      border-top: 1px solid var(--kong-border);
      background: var(--kong-surface);
      padding: 1.5rem;
      gap: 0.75rem;
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1); /* Dark-mode top shadow */
      margin: 0;                      /* Zero margin */
    }
    #prompt {
      flex: 1;
      padding: 0.875rem 1rem;
      border: 1px solid var(--kong-border);
      border-radius: 0.375rem;
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      min-height: 44px;
      max-height: 200px;
      overflow-y: auto;
      line-height: 1.5;
      background: var(--kong-accent);
      color: var(--kong-text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    #prompt:focus {
      outline: none;
      border-color: var(--kong-primary);
      box-shadow: 0 0 0 3px rgba(0, 82, 234, 0.2); /* Dark-mode glow */
    }
    #prompt::placeholder {
      color: var(--kong-text-muted);
    }
    #send {
      align-self: flex-end;
      padding: 0.75rem 1.5rem;
      background: var(--kong-primary);
      color: var(--kong-text);
      border: none;
      border-radius: 0.375rem;
      font-weight: 500;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s;
    }
    #send:hover:not(:disabled) { background: rgb(66, 140, 220); }
    #send:disabled { background: var(--kong-text-muted); cursor: not-allowed; }

    /* Tables (Dark Kong-style: Inverted colors) */
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 1rem 0;
      font-size: 0.875rem;
      background: var(--kong-accent);
      border-radius: 0.375rem;
      overflow: hidden;
      box-shadow: var(--kong-shadow);
    }
    th, td {
      border: 1px solid var(--kong-border);
      padding: 0.75rem;
      text-align: left;
      color: var(--kong-text);
    }
    th {
      background: var(--kong-primary);
      font-weight: 600;
      color: var(--kong-text);
    }

    /* Mobile: Collapse sidebar */
    @media (max-width: 768px) {
      :root { --sidebar-width: 0; }
      #sidebar { transform: translateX(-100%); }
      #main { left: 0; }
      /* #chat-container { padding: 1rem; } */
    }

    /* Dark Scrollbar (Portal-like subtle) */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--kong-surface); }
    ::-webkit-scrollbar-thumb { 
      background: var(--kong-border); 
      border-radius: 4px; 
    }
    ::-webkit-scrollbar-thumb:hover { background: var(--kong-primary); }
  </style>
</head>
<body>

  <!-- Sidebar (Absolute Fixed) -->
  <nav id="sidebar">
    <div id="sidebar-header">
      <!-- Inline Kong Logo SVG (working, vector gorilla head) -->
      <svg class="hidden dark:inline" width="200" height="32" viewBox="0 0 200 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M62.2669 21.7462H67.2191V14.1778H62.2669V21.7462ZM62.4403 24.7736C61.0619 24.7736 60.3459 24.5502 59.756 23.9365C58.8697 23.0491 58.5259 21.8155 58.5259 17.9919C58.5259 14.1683 58.8697 12.9347 59.756 12.0221C60.3238 11.4305 61.0619 11.207 62.4403 11.207H67.0456C68.424 11.207 69.14 11.4305 69.7299 12.0221C70.6162 12.9347 70.96 14.1432 70.96 17.9919C70.96 21.8406 70.6162 23.0491 69.7299 23.9365C69.14 24.5533 68.424 24.7736 67.0456 24.7736H62.4403Z" fill="white"></path>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M82.1574 15.4834C82.1574 15.5306 82.1574 15.5778 82.1574 15.6281V24.7701H85.9236V15.1844C85.9236 13.1955 85.7028 12.4812 85.135 11.9399C84.6177 11.4238 83.8765 11.1909 82.7188 11.1909L79.4069 11.2004L77.508 12.9092V11.2004H76.2368H73.7544V24.767H77.5206V14.1711H82.1511V15.4771L82.1574 15.4834Z" fill="white"></path>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M52.6367 7.46777H57.1221L50.6811 15.5996L57.3934 24.7698H52.6367L47.53 17.5664L46.3187 17.5601V24.7698H42.2812V7.46777H46.3187V14.174H47.53L52.6367 7.46777Z" fill="white"></path>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M97.4859 11.2043V12.9131L95.587 11.2043L92.7608 11.1948C91.4076 11.1948 90.6127 11.4277 89.9976 12.0162C89.1838 12.8501 88.7896 14.6754 88.7896 18.0175C88.7896 21.3595 89.1113 23.1093 89.8967 23.9212C90.5118 24.5097 91.2436 24.7709 92.6977 24.7709H97.4764L97.4827 26.7125L90.8493 26.7251L90.8556 27.5213L92.5684 29.4158H97.754C99.1324 29.4158 99.921 29.1703 100.413 28.6542C101.028 28.0154 101.274 27.6189 101.274 25.287V11.2074H97.4827L97.4859 11.2043ZM97.5111 21.7309H92.5589V14.175H97.508V21.7309H97.5111Z" fill="white"></path>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M11.6089 27.3795L12.4877 26.2563H18.9908L22.3805 30.5448L21.7779 31.9998H13.3916L13.5925 30.5448L11.6089 27.3795Z" fill="#428CDC"></path>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M13.5923 12.7572L16.7324 7.38525H20.3915L36.7927 26.25L35.5211 32.0002H28.4883L28.9295 30.3861L13.5923 12.7572Z" fill="#428CDC"></path>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M17.397 6.36383L18.9005 3.6105L23.4112 0L31.14 6.00018L30.1377 7.0132L31.483 8.85741V10.8315L27.6317 13.9485L21.1691 6.36383H17.397Z" fill="#428CDC"></path>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M5.45639 18.3602H7.49931L12.8264 13.9478L19.8861 22.0707L17.8949 25.029H11.3783L6.87867 30.695L5.84429 31.9987H0V25.0541L5.45639 18.3602Z" fill="#428CDC"></path>
            <!-- <path d="M191.698 23.3611V12.7227H195.293C196.124 12.7227 196.806 12.8646 197.34 13.1486C197.873 13.4291 198.268 13.8152 198.524 14.307C198.78 14.7987 198.908 15.358 198.908 15.9848C198.908 16.6117 198.78 17.1675 198.524 17.6523C198.268 18.1371 197.875 18.5181 197.345 18.7951C196.815 19.0687 196.138 19.2055 195.314 19.2055H192.405V18.0419H195.272C195.84 18.0419 196.297 17.9588 196.643 17.7925C196.993 17.6263 197.246 17.3908 197.402 17.0861C197.561 16.7779 197.641 16.4108 197.641 15.9848C197.641 15.5589 197.561 15.1866 197.402 14.868C197.243 14.5494 196.988 14.3035 196.638 14.1304C196.289 13.9538 195.826 13.8655 195.251 13.8655H192.986V23.3611H191.698ZM196.706 18.5821L199.324 23.3611H197.828L195.251 18.5821H196.706Z" fill="#428CDC"></path>
            <path d="M181.786 23.3611V12.7227H188.207V13.8655H183.074V17.4601H187.874V18.6029H183.074V22.2183H188.29V23.3611H181.786Z" fill="#428CDC"></path>
            <path d="M171.33 23.3611V12.7227H174.924C175.759 12.7227 176.441 12.8733 176.971 13.1746C177.504 13.4724 177.899 13.8758 178.155 14.3849C178.412 14.894 178.54 15.4619 178.54 16.0887C178.54 16.7155 178.412 17.2852 178.155 17.7977C177.902 18.3103 177.511 18.7189 176.981 19.0237C176.451 19.3249 175.773 19.4756 174.945 19.4756H172.368V18.3328H174.903C175.475 18.3328 175.934 18.2341 176.28 18.0367C176.626 17.8393 176.877 17.5726 177.033 17.2367C177.193 16.8974 177.272 16.5147 177.272 16.0887C177.272 15.6628 177.193 15.2818 177.033 14.9459C176.877 14.61 176.625 14.3468 176.275 14.1564C175.925 13.9624 175.461 13.8655 174.883 13.8655H172.618V23.3611H171.33Z" fill="#428CDC"></path>
            <path d="M167.994 18.0413C167.994 19.1634 167.792 20.133 167.387 20.9503C166.981 21.7676 166.426 22.3978 165.719 22.8411C165.013 23.2844 164.206 23.506 163.298 23.506C162.391 23.506 161.584 23.2844 160.878 22.8411C160.171 22.3978 159.615 21.7676 159.21 20.9503C158.805 20.133 158.603 19.1634 158.603 18.0413C158.603 16.9193 158.805 15.9497 159.21 15.1324C159.615 14.3151 160.171 13.6848 160.878 13.2416C161.584 12.7983 162.391 12.5767 163.298 12.5767C164.206 12.5767 165.013 12.7983 165.719 13.2416C166.426 13.6848 166.981 14.3151 167.387 15.1324C167.792 15.9497 167.994 16.9193 167.994 18.0413ZM166.748 18.0413C166.748 17.1202 166.594 16.3427 166.285 15.709C165.981 15.0752 165.567 14.5956 165.044 14.2701C164.524 13.9446 163.943 13.7818 163.298 13.7818C162.654 13.7818 162.071 13.9446 161.548 14.2701C161.028 14.5956 160.615 15.0752 160.306 15.709C160.002 16.3427 159.849 17.1202 159.849 18.0413C159.849 18.9625 160.002 19.74 160.306 20.3737C160.615 21.0074 161.028 21.4871 161.548 21.8126C162.071 22.1381 162.654 22.3009 163.298 22.3009C163.943 22.3009 164.524 22.1381 165.044 21.8126C165.567 21.4871 165.981 21.0074 166.285 20.3737C166.594 19.74 166.748 18.9625 166.748 18.0413Z" fill="#428CDC"></path>
            <path d="M150.033 23.3611V12.7227H151.321V22.2183H156.267V23.3611H150.033Z" fill="#428CDC"></path>
            <path d="M140.122 23.3611V12.7227H146.542V13.8655H141.41V17.4601H146.21V18.6029H141.41V22.2183H146.625V23.3611H140.122Z" fill="#428CDC"></path>
            <path d="M129.501 12.7227L132.659 21.6781H132.784L135.942 12.7227H137.293L133.387 23.3611H132.057L128.15 12.7227H129.501Z" fill="#428CDC"></path>
            <path d="M119.153 23.3611V12.7227H125.573V13.8655H120.441V17.4601H125.241V18.6029H120.441V22.2183H125.656V23.3611H119.153Z" fill="#428CDC"></path>
            <path d="M110.751 23.3611H107.468V12.7227H110.896C111.928 12.7227 112.811 12.9356 113.545 13.3616C114.28 13.7841 114.842 14.3918 115.234 15.1849C115.625 15.9745 115.821 16.9199 115.821 18.0211C115.821 19.1293 115.623 20.0834 115.228 20.8833C114.834 21.6798 114.259 22.2928 113.504 22.7222C112.749 23.1481 111.831 23.3611 110.751 23.3611ZM108.756 22.2183H110.668C111.547 22.2183 112.276 22.0486 112.855 21.7092C113.433 21.3699 113.864 20.8868 114.148 20.26C114.432 19.6332 114.574 18.8869 114.574 18.0211C114.574 17.1623 114.434 16.4229 114.153 15.803C113.873 15.1797 113.454 14.7018 112.896 14.3693C112.339 14.0334 111.644 13.8655 110.813 13.8655H108.756V22.2183Z" fill="#428CDC"></path> -->
        </svg>
    </div>
    <div id="mcp-section">
      <h3>MCP Servers</h3>
      <label class="mcp-checkbox">
        <input type="checkbox" value="Financial" checked />
        Financial
      </label>
      <label class="mcp-checkbox">
        <input type="checkbox" value="Claims" checked />
        Claims
      </label>
    </div>
  </nav>

  <!-- Main Content -->
  <main id="main">
    <div id="chat-container"></div>
    <div id="input-area">
      <textarea id="prompt" placeholder="Ask about financial claims & orders… (Shift+Enter for new line)" autocomplete="off"></textarea>
      <button id="send">Send</button>
    </div>
  </main>

  <script>
    // === Marked Config ===
    marked.setOptions({
      gfm: true,
      tables: true,
      breaks: true,
      headerIds: false,
    });

    // === DOM Elements ===
    const chatEl = document.getElementById('chat-container');
    const promptEl = document.getElementById('prompt');
    const sendBtn = document.getElementById('send');
    const checkboxes = document.querySelectorAll('.mcp-checkbox input[type="checkbox"]');

    let currentBotMsg = null;
    let streamReader = null;

    // === Auto-resize Textarea ===
    function resizePrompt() {
      promptEl.style.height = 'auto';
      promptEl.style.height = Math.min(promptEl.scrollHeight, 200) + 'px';
    }
    promptEl.addEventListener('input', resizePrompt);
    resizePrompt();

    // === Get Selected MCP Servers ===
    function getSelectedMcpServers() {
      return Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    }

    // === Add Message ===
    function addMessage(role, html = '') {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      if (html) div.innerHTML = html;
      chatEl.appendChild(div);
      div.scrollIntoView({ behavior: 'smooth' });
      return div;
    }

    // === Render Markdown ===
    function renderMarkdown(md) {
      const rawHTML = marked.parse(md);
      const wrapper = document.createElement('div');
      wrapper.innerHTML = rawHTML;
      wrapper.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
      return wrapper.innerHTML;
    }

    // === Send Prompt (POST JSON + SSE) ===
    async function sendPrompt() {
      const text = promptEl.value.trim();
      if (!text) return;

      const mcpServers = getSelectedMcpServers();
      if (mcpServers.length === 0) {
        alert('Select at least one MCP server.');
        return;
      }

      addMessage('user', text.replace(/\n/g, '<br>'));
      promptEl.value = '';
      resizePrompt();
      sendBtn.disabled = true;

      currentBotMsg = addMessage('bot', '<span class="typing">Thinking…</span>');

      try {
        const response = await fetch('/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: text, mcpServers }),
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        // Handle SSE from POST response body
        const reader = response.body?.getReader();
        if (!reader) throw new Error('No response body');

        const decoder = new TextDecoder();
        let accumulated = '';
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');

          // Keep last incomplete line in buffer
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6).trim();
              if (data) {
                try {
                  const json = JSON.parse(data);
                  if (json.content) {
                    accumulated += json.content;
                    currentBotMsg.innerHTML = renderMarkdown(accumulated);
                    currentBotMsg.scrollIntoView({ behavior: 'smooth' });
                  }
                } catch (err) {
                  console.error('Invalid JSON chunk:', data);
                }
              }
            } else if (line.startsWith('event: done')) {
              finishStreaming();
              return;
            } else if (line.startsWith('event: error')) {
              currentBotMsg.innerHTML = '<em style="color: #ef4444;">Error: Connection failed.</em>';
              finishStreaming();
              return;
            }
          }
        }

        finishStreaming();
      } catch (err) {
        console.error('Fetch error:', err);
        currentBotMsg.innerHTML = `<em style="color: #ef4444;">Error: ${err.message}</em>`;
        finishStreaming();
      }
    }

    function finishStreaming() {
      sendBtn.disabled = false;
      promptEl.focus();
      currentBotMsg = null;
      streamReader = null;
    }

    // === Event Listeners ===
    sendBtn.addEventListener('click', sendPrompt);
    promptEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.shiftKey) {
        // Shift+Enter: new line
        e.preventDefault();
        const start = promptEl.selectionStart;
        const end = promptEl.selectionEnd;
        promptEl.value = promptEl.value.substring(0, start) + '\n' + promptEl.value.substring(end);
        promptEl.selectionStart = promptEl.selectionEnd = start + 1;
        resizePrompt();
      } else if (e.key === 'Enter' && !e.shiftKey) {
        // Enter: send
        e.preventDefault();
        sendPrompt();
      }
    });

    // Initial focus
    promptEl.focus();
  </script>
</body>
</html>