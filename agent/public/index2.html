<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Orders Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Marked.js (Markdown → HTML) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Highlight.js (code blocks) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    body {font-family: system-ui, sans-serif; margin:0; display:flex; flex-direction:column; height:100vh; background:#f9f9fb;}
    #chat {flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:0.75rem;}
    .msg {max-width:80%; padding:0.75rem 1rem; border-radius:1rem; line-height:1.4;}
    .user {align-self:flex-end; background:#007bff; color:#fff;}
    .bot  {align-self:flex-start; background:#e9ecef; color:#212529;}
    .typing {font-style:italic; color:#777;}
    #inputArea {display:flex; border-top:1px solid #ddd; background:#fff;}
    #prompt {flex:1; padding:0.75rem 1rem; border:none; font-size:1rem;}
    #prompt:focus {outline:none;}
    #send {padding:0 1.2rem; background:#007bff; color:#fff; border:none; font-weight:bold; cursor:pointer;}
    #send:disabled {background:#aaa; cursor:not-allowed;}
  </style>
</head>
<body>

<div id="chat"></div>

<div id="inputArea">
  <input id="prompt" type="text" placeholder="Ask about users & orders…" autocomplete="off">
  <button id="send">Send</button>
</div>

<script>
  // ---------- Config ----------
  const SSE_URL = 'http://localhost:3443/ask?q='; // query‑string prompt
  // ---------------------------------
    
  const chatEl    = document.getElementById('chat');
  const promptEl  = document.getElementById('prompt');
  const sendBtn   = document.getElementById('send');

  let currentBotMsg = null;      // <div> that receives streaming markdown
  let es = null;                 // EventSource instance

  // Helper: create a message bubble
  function addMessage(role, html = '') {
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    if (html) div.innerHTML = html;
    chatEl.appendChild(div);
    div.scrollIntoView({behavior: 'smooth'});
    return div;
  }

  // Render markdown → HTML (with code highlighting)
  function renderMarkdown(md) {
    const rawHTML = marked.parse(md);
    const wrapper = document.createElement('div');
    wrapper.innerHTML = rawHTML;
    wrapper.querySelectorAll('pre code').forEach(block => {
      hljs.highlightElement(block);
    });
    return wrapper.innerHTML;
  }

  // ---------- Send prompt ----------
  function sendPrompt() {
    const text = promptEl.value.trim();
    if (!text) return;

    // 1. UI: user message
    addMessage('user', text.replace(/\n/g, '<br>'));
    promptEl.value = '';
    sendBtn.disabled = true;

    // 2. UI: placeholder for streaming bot reply
    currentBotMsg = addMessage('bot', '<span class="typing">…</span>');

    // 3. Start SSE
    const url = SSE_URL + encodeURIComponent(text);
    es = new EventSource(url);

    let accumulated = '';   // full markdown received so far

    es.onmessage = (e) => {
      if (e.data === '') return;               // heartbeat keep‑alive
      accumulated += JSON.parse(e.data).content;
      currentBotMsg.innerHTML = renderMarkdown(accumulated);
      currentBotMsg.scrollIntoView({behavior: 'smooth'});
    };

    es.addEventListener('done', () => {
      es.close();
      finishStreaming();
    });

    es.onerror = (err) => {
      console.error('SSE error', err);
      currentBotMsg.innerHTML = '<em style="color:red;">Connection error – try again.</em>';
      es.close();
      finishStreaming();
    };
  }

  function finishStreaming() {
    sendBtn.disabled = false;
    promptEl.focus();
    currentBotMsg = null;
    es = null;
  }

  // ---------- UI wiring ----------
  sendBtn.addEventListener('click', sendPrompt);
  promptEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendPrompt();
    }
  });

  // Initial focus
  promptEl.focus();
</script>

</body>
</html>